name: Build (Release)

on:
  pull_request_target:
    branches:
      - main
    types:
      - closed

permissions:
  contents: write

jobs:
  build-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      # 1. 環境構築 (Node.js, npm, Vite, Emscripten, CMake) + キャッシュ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # TypeScript ビルドキャッシュの復元
      - name: Restore TS build cache
        uses: actions/cache@v4
        with:
          path: ./.tsbuildinfo
          # keyのハッシュ生成に package-lock.json と .tsbuildinfo の両方を使用
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('./.tsbuildinfo') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v12
        with:
          version: latest

      - name: Cache emscripten build
        uses: actions/cache@v4
        with:
          path: |
            build_release
            build_debug
          key: emscripten-${{ runner.os }}-${{ steps.mode.outputs.mode }}
          restore-keys: |
            emscripten-${{ runner.os }}-

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2.0
        with:
          cmake-version: '3.27.0'

      # 2. ソースファイル変更検出 & ビルド
      - name: Detect source changes
        id: src_changes
        run: |
          SRC_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(ts|tsx|jsx|cpp)$' || true)
          if [ -z "$SRC_CHANGED" ]; then
            echo "src=false" >> $GITHUB_OUTPUT
          else
            echo "src=true" >> $GITHUB_OUTPUT
          fi

      - name: Detect release mode
        id: release
        run: |
          # 変更ファイル一覧を取得
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git ls-files)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # コミットメッセージ取得
          PR_TITLE=$(git log -1 --pretty=%B)
          echo "PR title: $PR_TITLE"

          # 条件1: コミットメッセージに特定文字列が含まれるか
          if echo "$PR_TITLE" | grep -q "アプリの新バージョンをリリース"; then
            MSG_OK=true
          else
            MSG_OK=false
          fi

          # 条件2: version.yml が変更されているか
          if echo "$CHANGED_FILES" | grep -q "^assets/release/version.yml$"; then
            VERSION_OK=true
          else
            VERSION_OK=false
          fi

          # 両方満たしたらリリースモード
          if [ "$MSG_OK" = true ] && [ "$VERSION_OK" = true ]; then
            echo "mode=release" >> $GITHUB_OUTPUT
          fi

      - name: Build C++ (Wasm)
        if: steps.src_changes.outputs.src == 'true'
        run: |
          if [ "${{ steps.mode.outputs.mode }}" = "release" ]; then
            emcmake cmake -B build_release -DCMAKE_BUILD_TYPE=Release
            cmake --build build_release
          fi

      # 3. Vite ビルド (リリース時はバンドル, ミニフィケーションも含む)
      - name: Vite bundle
        run: |
          if [ "${{ steps.mode.outputs.mode }}" = "release" ]; then
            npm run build:release
          fi

      # 4. GitHub Pages デプロイ
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ steps.mode.outputs.mode == 'release' && './app'}}