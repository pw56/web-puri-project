# detection.js

## detectFaces (関数)
- 概要
> 入力された画像データからTensorFlow.jsのCOCO-SSDモデルを用いて単数または複数の人物を検出しランドマークの処理範囲を限定し、検出した人物の信頼度(score)が0.5以上のものだけ、それぞれの人物の顔でFaceクラスのインスタンスを生成し、それらのインスタンスを配列で返す。

- 引数
> 第1引数: 検出する画像(ImageDataオブジェクト)
> 
> 例:  
> ```javascript
> ImageData //第1引数
> ```

- 返り値
> 検出された顔のインスタンス(Faceオブジェクト)が入った配列
> 
> 例:  
> ```javascript
> [Face, Face, Face...]
> ```

## Face (クラス)
- 概要
> 入力された顔の情報を保持、抽出するためのクラス。
> 抽出処理にはTensorFlow.jsのFace Landmarks Detectionモデルを使用する。

> ### コンストラクタ
> - 概要
> > 入力された顔からパーツを抽出。
> > パーツの右(right)、左(left)は検出対象の顔、つまり本人の視点からの判断にする。
> > インスタンス生成時にWeb Workerを立ち上げ、Face Landmarks Detectionモデルで顔のパーツを検出しておく。
> > 涙袋はFace Landmarks Detectionモデルの実行完了後に同じWeb Workerで目元の明暗の境界から検出する。
> > 人物の体全体はインスタンス生成時にFace Landmarks Detectionモデルとは別のWeb Workerを立ち上げ、MediaPipe Selfie Segmentationモデルで処理する。
> > 体全体の境界の情報は今後の処理の精度に大きく影響するので、可能な限り微細化する。
> > 体全体の境界線を除く、顔の全てのランドマークの検出後に別のWeb Workerを立ち上げ、パーツごとの周囲との色の変化(周囲との数値の比較で突出した部分)や座標分布の変化予測(微分積分など)などから境界線を微細化し、座標情報の精度を上げる。
> > 元の画像のバウンディングボックスの範囲を、別の画像として一時プライベート変数に保存して高速化し、機械学習モデルで処理する際に使用。
> > 検出されたパーツの座標は、バウンディングボックス内の座標から元の画像の座標に変換し、プライベート変数に保存して高速化。
> > 処理が失敗した場合は、プライベート変数に"false"を代入する。
> > このクラスのメソッドから返される座標は、バウンディングボックス内の座標を元の画像の座標に変換されたものである。
> > またこのクラスは一度画像が代入されると、画像は変更されないものと想定されている。
> > 
> - 引数
> > 第1引数: 検出元の画像(ImageDataオブジェクト)  
> > 第2引数: COCO-SSDモデルで返されたオブジェクトの対象の顔のバウンディングボックス
> > 
> > 例:  
> > ```javascript
> > ImageData, //第1引数
> > [x, y, width, height] //第2引数
> > ```
> 
> ### hasProcessed (メソッド)
> - 概要
> > 顔のパーツの検出が完了したかを返す。
> 
> - 引数
> > 第1引数: なし
> 
> - 返り値
> > 処理が完了したかを表すBool値
> > 
> > 例:  
> > ```javascript
> > true
> > ```
> 
> ### faceAngle (メソッド)
> - 概要
> > 顔の傾き(角度)を返す。
> 
> - 引数
> > 第1引数: なし
> 
> - 返り値
> > 小数を含む顔の軸ごと(X, Y, Z)の傾きの角度(-180° ~ 180°)
> > 
> > 例:  
> > ```javascript
> > -21.865,
> > 10,
> > -2.562
> > ```
> 
> ### isFaceTouched (メソッド)
> - 概要
> > 入力された元の画像の座標が、このオブジェクトの保持している顔(Face Landmarks Detectionモデルで検出した顔の輪郭の内側)の範囲内かを判別する。
> 
> - 引数
> > 第1引数: 座標の配列
> >
> > 例:
> > ```javascript
> >   [20, 60]
> > ```
> 
> - 返り値
> > 入力された座標が顔に重なっているかのBool値
> > 
> > 例:  
> > ```javascript
> > true
> > ```
>
> ### body (メソッド)
> - 概要
> > クラス内のプライベート変数が保持している体全体の座標を返す。
> > 見つからなかったら("false"が返されたら)例外を返す。
> 
> - 引数
> > 第1引数: なし
> 
> - 返り値
> > 検出された体全体の背景との境界の座標の配列
> > 
> > 例:  
> > ```javascript
> > [[7, 5], [8, 5], [10, 8]...]
> > ```
> 
> ### contour (メソッド)
> - 概要
> > クラス内のプライベート変数が保持している顔の輪郭の座標を返す。
> > 見つからなかったら("false"が返されたら)例外を返す。
> 
> - 引数
> > 第1引数: なし
> 
> - 返り値
> > 検出された顔の輪郭の座標の配列
> > 
> > 例:  
> > ```javascript
> > [[0, 0, 0], [1, 2, 1], [5, 8, 2]...]
> > ```
> 
> ### eyes (メソッド)
> - 概要
> > クラス内のプライベート変数が保持している左右の目の縁(目と肌の境目)の座標を、"left"と"right"のキーを持つ辞書に、左右それぞれの座標の配列を入れて返す。
> > 見つからなかったら("false"が返されたら)例外を返す。
> 
> - 引数
> > 第1引数: なし
> 
> - 返り値
> > 左右の目の縁の座標が入った配列を持つ辞書
> > 
> > 例:
> > ```javascript
> > {
> >   "left": [[0, 0, 2], [1, 2, 2], [3, 7, 4]...]
> >   "right": [[0, 0, 2], [1, 2, 3], [3, 7, 6]...]
> > }
> > ```
> 
> ### nose (メソッド)
> - 概要
> > クラス内のプライベート変数が保持している肌と鼻の境界線の座標の配列を返す。
> > 見つからなかったら("false"が返されたら)例外を返す。
> 
> - 引数
> > 第1引数: なし
> 
> - 返り値
> > 鼻の縁(鼻と肌の境目)の座標の配列
> > 
> > 例:  
> > ```javascript
> > [[0, 0, 2], [1, 2, 5], [5, 8, 6]...]
> > ```
>
> ### mouth (メソッド)
> - 概要
> > クラス内のプライベート変数が保持している肌と口の境界線の座標の配列を返す。
> > 見つからなかったら("false"が返されたら)例外を返す。
> 
> - 引数
> > 第1引数: なし
> 
> - 返り値
> > 口の縁(口と肌の境目)の座標の配列
> > 
> > 例:  
> > ```javascript
> > [[100, 20, 30], [110, 22, 32], [115, 28, 35]...]
> > ```
>
> ### eyebrows (メソッド)
> - 概要
> > クラス内のプライベート変数が保持している左右の眉毛の上下を含めた全体の縁(眉毛と肌の境目)の座標を、"left"と"right"のキーを持つ辞書に、左右それぞれの座標の配列を入れて返す。
> > 見つからなかったら("false"が返されたら)例外を返す。
> 
> - 引数
> > 第1引数: なし
> 
> - 返り値
> > 左右の眉毛の縁の座標が入った配列を持つ辞書
> > 
> > 例:
> > ```javascript
> > {
> >   "left": [[10, 5, 1], [11, 7, 2], [13, 7, 2]...]
> >   "right": [[20, 5, 2], [23, 5, 3], [24, 7, 2]...]
> > }
> > ```
>
> ### eyebags (メソッド)
> - 概要
> > クラス内のプライベート変数が保持している左右の涙袋の縁(涙袋と肌の境目)の座標を、"left"と"right"のキーを持つ辞書に、左右それぞれの座標の配列を入れて返す。
> > 見つからなかったら("false"が返されたら)例外を返す。
> 
> - 引数
> > 第1引数: なし
> 
> - 返り値
> > 左右の涙袋の縁の座標が入った配列を持つ辞書
> > 
> > 例:
> > ```javascript
> > {
> >   "left": [[11, 10, 1], [11, 9, 2], [13, 8, 2]...]
> >   "right": [[20, 10, 2], [23, 8, 3], [24, 8, 2]...]
> > }
> > ```
