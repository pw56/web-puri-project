<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プリクラ(仮)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: 'var(--background)',
                        foreground: 'var(--foreground)',
                        card: 'var(--card)',
                        'card-foreground': 'var(--card-foreground)',
                        popover: 'var(--popover)',
                        'popover-foreground': 'var(--popover-foreground)',
                        primary: 'var(--primary)',
                        'primary-foreground': 'var(--primary-foreground)',
                        secondary: 'var(--secondary)',
                        'secondary-foreground': 'var(--secondary-foreground)',
                        muted: 'var(--muted)',
                        'muted-foreground': 'var(--muted-foreground)',
                        accent: 'var(--accent)',
                        'accent-foreground': 'var(--accent-foreground)',
                        destructive: 'var(--destructive)',
                        'destructive-foreground': 'var(--destructive-foreground)',
                        border: 'var(--border)',
                        input: 'var(--input)',
                        'input-background': 'var(--input-background)',
                        ring: 'var(--ring)',
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                        xl: 'calc(var(--radius) + 4px)',
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --font-size: 14px;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            --background: #ffffff;
            --foreground: oklch(0.145 0 0);
            --card: #ffffff;
            --card-foreground: oklch(0.145 0 0);
            --popover: oklch(1 0 0);
            --popover-foreground: oklch(0.145 0 0);
            --primary: #030213;
            --primary-foreground: oklch(1 0 0);
            --secondary: oklch(0.95 0.0058 264.53);
            --secondary-foreground: #030213;
            --muted: #ececf0;
            --muted-foreground: #717182;
            --accent: #e9ebef;
            --accent-foreground: #030213;
            --destructive: #d4183d;
            --destructive-foreground: #ffffff;
            --border: rgba(0, 0, 0, 0.1);
            --input: transparent;
            --input-background: #f3f3f5;
            --switch-background: #cbced4;
            --font-weight-medium: 500;
            --font-weight-normal: 400;
            --ring: oklch(0.708 0 0);
            --radius: 0.625rem;
        }

        .dark {
            --background: oklch(0.145 0 0);
            --foreground: oklch(0.985 0 0);
            --card: oklch(0.145 0 0);
            --card-foreground: oklch(0.985 0 0);
            --popover: oklch(0.145 0 0);
            --popover-foreground: oklch(0.985 0 0);
            --primary: oklch(0.985 0 0);
            --primary-foreground: oklch(0.205 0 0);
            --secondary: oklch(0.269 0 0);
            --secondary-foreground: oklch(0.985 0 0);
            --muted: oklch(0.269 0 0);
            --muted-foreground: oklch(0.708 0 0);
            --accent: oklch(0.269 0 0);
            --accent-foreground: oklch(0.985 0 0);
            --destructive: oklch(0.396 0.141 25.723);
            --destructive-foreground: oklch(0.637 0.237 25.331);
            --border: oklch(0.269 0 0);
            --input: oklch(0.269 0 0);
            --ring: oklch(0.439 0 0);
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--background);
            color: var(--foreground);
        }

        .lucide {
            width: 1em;
            height: 1em;
            display: inline-block;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Typography */
        h1 {
            font-size: var(--text-2xl);
            font-weight: var(--font-weight-medium);
            line-height: 1.5;
        }

        h2 {
            font-size: var(--text-xl);
            font-weight: var(--font-weight-medium);
            line-height: 1.5;
        }

        h3 {
            font-size: var(--text-lg);
            font-weight: var(--font-weight-medium);
            line-height: 1.5;
        }

        /* Custom range slider styles */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: var(--secondary);
            height: 6px;
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-track {
            background: var(--secondary);
            height: 6px;
            border-radius: 3px;
        }

        input[type="range"]::-moz-range-thumb {
            border: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useCallback, useEffect } = React;

        // Lucide React Icons as SVG components
        const Camera = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                <circle cx="12" cy="13" r="3"/>
            </svg>
        );

        const ArrowLeft = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="m12 19-7-7 7-7"/>
                <path d="M19 12H5"/>
            </svg>
        );

        const Palette = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/>
                <circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/>
                <circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/>
                <circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/>
                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>
            </svg>
        );

        const Download = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );

        const Share2 = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="18" cy="5" r="3"/>
                <circle cx="6" cy="12" r="3"/>
                <circle cx="18" cy="19" r="3"/>
                <line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/>
                <line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/>
            </svg>
        );

        const Heart = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
            </svg>
        );

        const Star = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
            </svg>
        );

        const Sparkles = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
                <path d="M5 3v4"/>
                <path d="M19 17v4"/>
                <path d="M3 5h4"/>
                <path d="M17 19h4"/>
            </svg>
        );

        const RefreshCw = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                <path d="M8 16H3v5"/>
            </svg>
        );

        const AlertCircle = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" x2="12" y1="8" y2="12"/>
                <line x1="12" x2="12.01" y1="16" y2="16"/>
            </svg>
        );

        const Play = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polygon points="6,3 20,12 6,21"/>
            </svg>
        );

        const Type = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polyline points="4,7 4,4 20,4 20,7"/>
                <line x1="9" x2="15" y1="20" y2="20"/>
                <line x1="12" x2="12" y1="4" y2="20"/>
            </svg>
        );

        const Sticker = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/>
                <path d="M14 3v4a2 2 0 0 0 2 2h4"/>
            </svg>
        );

        const RotateCw = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
            </svg>
        );

        const Trash2 = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                <line x1="10" x2="10" y1="11" y2="17"/>
                <line x1="14" x2="14" y1="11" y2="17"/>
            </svg>
        );

        // UI Components
        const Button = ({ children, className = "", variant = "default", size = "default", onClick, disabled, ...props }) => {
            const baseClasses = "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50";
            
            const variants = {
                default: "bg-primary text-primary-foreground hover:bg-primary/90",
                destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
                outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
                secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
                ghost: "hover:bg-accent hover:text-accent-foreground",
                link: "text-primary underline-offset-4 hover:underline"
            };
            
            const sizes = {
                default: "h-10 px-4 py-2",
                sm: "h-9 rounded-md px-3",
                lg: "h-11 rounded-md px-8",
                icon: "h-10 w-10"
            };
            
            return (
                <button
                    className={`${baseClasses} ${variants[variant]} ${sizes[size]} ${className}`}
                    onClick={onClick}
                    disabled={disabled}
                    {...props}
                >
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = "", ...props }) => (
            <div className={`rounded-lg border bg-card text-card-foreground shadow-sm ${className}`} {...props}>
                {children}
            </div>
        );

        const Badge = ({ children, className = "", ...props }) => (
            <div className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-primary text-primary-foreground hover:bg-primary/80 ${className}`} {...props}>
                {children}
            </div>
        );

        const Alert = ({ children, className = "", ...props }) => (
            <div className={`relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground ${className}`} {...props}>
                {children}
            </div>
        );

        const AlertDescription = ({ children, className = "", ...props }) => (
            <div className={`text-sm [&_p]:leading-relaxed ${className}`} {...props}>
                {children}
            </div>
        );

        const Tabs = ({ children, defaultValue, className = "", ...props }) => {
            const [activeTab, setActiveTab] = useState(defaultValue);
            
            return (
                <div className={className} {...props}>
                    {React.Children.map(children, child => 
                        React.cloneElement(child, { activeTab, setActiveTab })
                    )}
                </div>
            );
        };

        const TabsList = ({ children, className = "", activeTab, setActiveTab, ...props }) => (
            <div className={`inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground ${className}`} {...props}>
                {React.Children.map(children, child => 
                    React.cloneElement(child, { activeTab, setActiveTab })
                )}
            </div>
        );

        const TabsTrigger = ({ children, value, className = "", activeTab, setActiveTab, ...props }) => (
            <button
                className={`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 ${
                    activeTab === value ? "bg-background text-foreground shadow-sm" : ""
                } ${className}`}
                onClick={() => setActiveTab(value)}
                {...props}
            >
                {children}
            </button>
        );

        const TabsContent = ({ children, value, className = "", activeTab, ...props }) => {
            if (activeTab !== value) return null;
            
            return (
                <div className={`mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ${className}`} {...props}>
                    {children}
                </div>
            );
        };

        const Input = ({ className = "", type = "text", ...props }) => (
            <input
                type={type}
                className={`flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${className}`}
                {...props}
            />
        );

        const Label = ({ children, className = "", ...props }) => (
            <label className={`text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 ${className}`} {...props}>
                {children}
            </label>
        );

        const Slider = ({ value, onValueChange, max = 100, min = 0, step = 1, className = "", ...props }) => {
            const handleChange = (e) => {
                onValueChange([parseInt(e.target.value)]);
            };

            return (
                <input
                    type="range"
                    min={min}
                    max={max}
                    step={step}
                    value={value[0]}
                    onChange={handleChange}
                    className={`w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer ${className}`}
                    {...props}
                />
            );
        };

        // PurikuraCamera Component
        const PurikuraCamera = ({ onPhotoCapture }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);
            
            const [isStreaming, setIsStreaming] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [capturedPhotos, setCapturedPhotos] = useState([]);
            const [selectedFilter, setSelectedFilter] = useState({ id: 'none', name: 'なし', style: '' });
            const [selectedFrame, setSelectedFrame] = useState({ id: 'none', name: 'なし', style: '', borderStyle: '' });
            const [isCapturing, setIsCapturing] = useState(false);

            const filters = [
                { id: 'none', name: 'なし', style: '' },
                { id: 'pink', name: 'ピンク', style: 'sepia(20%) saturate(150%) hue-rotate(300deg)' },
                { id: 'vintage', name: 'ビンテージ', style: 'sepia(50%) contrast(120%)' },
                { id: 'bright', name: '明るめ', style: 'brightness(130%) contrast(110%)' },
                { id: 'soft', name: 'ソフト', style: 'blur(0.5px) brightness(115%)' }
            ];

            const frames = [
                { id: 'none', name: 'なし', style: '', borderStyle: '' },
                { id: 'heart', name: 'ハート', style: 'border-pink-300', borderStyle: 'border-8 rounded-3xl' },
                { id: 'star', name: 'スター', style: 'border-yellow-300', borderStyle: 'border-8 rounded-2xl' },
                { id: 'cute', name: 'キュート', style: 'border-purple-300', borderStyle: 'border-8 rounded-full' }
            ];

            const stopCamera = useCallback(() => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                    streamRef.current = null;
                }
                setIsStreaming(false);
            }, []);

            const startCamera = useCallback(async () => {
                setIsLoading(true);
                setError(null);
                
                try {
                    stopCamera();

                    const constraints = {
                        video: {
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        },
                        audio: false
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        streamRef.current = stream;
                        
                        videoRef.current.addEventListener('loadedmetadata', () => {
                            setIsStreaming(true);
                            setIsLoading(false);
                        }, { once: true });

                        videoRef.current.addEventListener('error', (e) => {
                            console.error('Video error:', e);
                            setError('ビデオの再生でエラーが発生しました');
                            setIsLoading(false);
                        }, { once: true });
                        
                    } else {
                        setError('ビデオ要素が見つかりません');
                        setIsLoading(false);
                    }
                } catch (err) {
                    console.error('カメラの起動に失敗:', err);
                    let errorMessage = 'カメラの起動に失敗しました。';
                    
                    if (err.name === 'NotAllowedError') {
                        errorMessage = 'カメラの使用が許可されていません。ブラウザの設定からカメラのアクセスを許可してください。';
                    } else if (err.name === 'NotFoundError') {
                        errorMessage = 'カメラが見つかりません。デバイスにカメラが接続されているか確認してください。';
                    } else if (err.name === 'NotSupportedError') {
                        errorMessage = 'このブラウザではカメラがサポートされていません。ChromeやFirefoxなどのモダンブラウザをお試しください。';
                    } else if (err.name === 'NotReadableError') {
                        errorMessage = 'カメラが他のアプリケーションで使用されています。他のアプリを閉じてから再度お試しください。';
                    } else if (location.protocol === 'http:' && location.hostname !== 'localhost') {
                        errorMessage = 'セキュリティ上の理由により、HTTPSでないとカメラを使用できません。HTTPSサイトでお試しください。';
                    }
                    
                    setError(errorMessage);
                    setIsLoading(false);
                }
            }, [stopCamera]);

            const capturePhoto = useCallback(() => {
                if (!videoRef.current || !canvasRef.current || !isStreaming) return;
                
                setIsCapturing(true);
                
                const canvas = canvasRef.current;
                const video = videoRef.current;
                const context = canvas.getContext('2d');
                
                if (!context) {
                    setIsCapturing(false);
                    return;
                }
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                context.filter = selectedFilter.style;
                context.drawImage(video, 0, 0);
                
                const dataUrl = canvas.toDataURL('image/png');
                const newPhoto = {
                    id: Date.now().toString(),
                    dataUrl,
                    timestamp: Date.now()
                };
                
                setCapturedPhotos(prev => [newPhoto, ...prev]);
                
                if (onPhotoCapture) {
                    onPhotoCapture(dataUrl);
                }
                
                setTimeout(() => setIsCapturing(false), 300);
            }, [selectedFilter, isStreaming, onPhotoCapture]);

            const downloadPhoto = (photo) => {
                const link = document.createElement('a');
                link.download = `purikura-${photo.timestamp}.png`;
                link.href = photo.dataUrl;
                link.click();
            };

            useEffect(() => {
                return () => stopCamera();
            }, [stopCamera]);

            return (
                <div className="max-w-6xl mx-auto">
                    <div className="text-center mb-6">
                        <h1 className="mb-2 bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent font-bold text-4xl">
                            ✨ プリクラ ✨
                        </h1>
                        <p className="text-muted-foreground">可愛い写真を撮ろう！</p>
                    </div>

                    {error && (
                        <Alert className="mb-6 border-red-200 bg-red-50">
                            <AlertCircle />
                            <AlertDescription className="text-red-800">
                                {error}
                                <div className="mt-2">
                                    <Button 
                                        onClick={startCamera} 
                                        size="sm" 
                                        variant="outline"
                                        className="mr-2"
                                    >
                                        <RefreshCw className="h-4 w-4 mr-1" />
                                        再試行
                                    </Button>
                                </div>
                            </AlertDescription>
                        </Alert>
                    )}

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2">
                            <Card className="p-6 bg-white/80 backdrop-blur-sm border-pink-200">
                                <div className="relative">
                                    <div className={`relative overflow-hidden rounded-2xl ${selectedFrame.borderStyle} ${selectedFrame.style} bg-gray-900 aspect-[4/3]`}>
                                        {!isStreaming && !isLoading && !error && (
                                            <div className="absolute inset-0 flex flex-col items-center justify-center text-white">
                                                <Camera className="h-16 w-16 mb-4 text-white/60" />
                                                <p className="text-white/80 mb-4">カメラを起動してください</p>
                                                <Button 
                                                    onClick={startCamera}
                                                    className="bg-pink-500 hover:bg-pink-600"
                                                >
                                                    <Play className="h-4 w-4 mr-2" />
                                                    カメラ起動
                                                </Button>
                                            </div>
                                        )}
                                        
                                        {isLoading && (
                                            <div className="absolute inset-0 flex flex-col items-center justify-center text-white">
                                                <div className="animate-spin rounded-full h-16 w-16 border-4 border-pink-500 border-t-transparent mb-4"></div>
                                                <p className="text-white/80">カメラを起動中...</p>
                                            </div>
                                        )}
                                        
                                        <video
                                            ref={videoRef}
                                            autoPlay
                                            playsInline
                                            muted
                                            className="w-full h-full object-cover"
                                            style={{ 
                                                filter: selectedFilter.style,
                                                display: isStreaming ? 'block' : 'none'
                                            }}
                                        />
                                        
                                        {isCapturing && isStreaming && (
                                            <div className="absolute inset-0 bg-white/80 flex items-center justify-center">
                                                <div className="text-2xl animate-pulse">📸 ✨</div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex justify-center mt-6">
                                        {!isStreaming ? (
                                            <Button
                                                onClick={startCamera}
                                                disabled={isLoading}
                                                size="lg"
                                                className="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white rounded-full px-8 py-4 text-lg shadow-lg"
                                            >
                                                <Camera className="mr-2 h-6 w-6" />
                                                {isLoading ? 'カメラ起動中...' : 'カメラ起動'}
                                            </Button>
                                        ) : (
                                            <div className="flex gap-4">
                                                <Button
                                                    onClick={capturePhoto}
                                                    disabled={!isStreaming || isCapturing}
                                                    size="lg"
                                                    className="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white rounded-full px-8 py-4 text-lg shadow-lg"
                                                >
                                                    <Camera className="mr-2 h-6 w-6" />
                                                    撮影する
                                                </Button>
                                                <Button
                                                    onClick={stopCamera}
                                                    variant="outline"
                                                    size="lg"
                                                    className="rounded-full px-6 py-4"
                                                >
                                                    停止
                                                </Button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </Card>

                            {isStreaming && (
                                <Card className="mt-4 p-4 bg-white/80 backdrop-blur-sm border-pink-200">
                                    <Tabs defaultValue="filters" className="w-full">
                                        <TabsList className="grid w-full grid-cols-2 mb-4">
                                            <TabsTrigger value="filters">フィルター</TabsTrigger>
                                            <TabsTrigger value="frames">フレーム</TabsTrigger>
                                        </TabsList>

                                        <TabsContent value="filters">
                                            <div className="grid grid-cols-5 gap-2">
                                                {filters.map((filter) => (
                                                    <Button
                                                        key={filter.id}
                                                        variant={selectedFilter.id === filter.id ? "default" : "outline"}
                                                        onClick={() => setSelectedFilter(filter)}
                                                        className="aspect-square flex flex-col items-center justify-center p-2 text-xs"
                                                    >
                                                        <Sparkles className="h-4 w-4 mb-1" />
                                                        {filter.name}
                                                    </Button>
                                                ))}
                                            </div>
                                        </TabsContent>

                                        <TabsContent value="frames">
                                            <div className="grid grid-cols-4 gap-2">
                                                {frames.map((frame) => (
                                                    <Button
                                                        key={frame.id}
                                                        variant={selectedFrame.id === frame.id ? "default" : "outline"}
                                                        onClick={() => setSelectedFrame(frame)}
                                                        className="aspect-square flex flex-col items-center justify-center p-2 text-xs"
                                                    >
                                                        {frame.id === 'heart' && <Heart className="h-4 w-4 mb-1" />}
                                                        {frame.id === 'star' && <Star className="h-4 w-4 mb-1" />}
                                                        {frame.id === 'cute' && <Sparkles className="h-4 w-4 mb-1" />}
                                                        {frame.id === 'none' && <RefreshCw className="h-4 w-4 mb-1" />}
                                                        {frame.name}
                                                    </Button>
                                                ))}
                                            </div>
                                        </TabsContent>
                                    </Tabs>
                                </Card>
                            )}
                        </div>

                        <div className="space-y-4">
                            <Card className="p-4 bg-white/80 backdrop-blur-sm border-pink-200">
                                <h3 className="mb-4 text-center">撮影した写真</h3>
                                {capturedPhotos.length === 0 ? (
                                    <div className="text-center text-muted-foreground py-8">
                                        <Camera className="h-12 w-12 mx-auto mb-2 text-pink-300" />
                                        まだ写真がありません
                                    </div>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {capturedPhotos.map((photo) => (
                                            <div key={photo.id} className="relative group">
                                                <img
                                                    src={photo.dataUrl}
                                                    alt="撮影した写真"
                                                    className="w-full rounded-lg shadow-md"
                                                />
                                                <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center">
                                                    <Button
                                                        onClick={() => downloadPhoto(photo)}
                                                        size="sm"
                                                        className="bg-white/90 text-black hover:bg-white"
                                                    >
                                                        <Download className="h-4 w-4 mr-1" />
                                                        保存
                                                    </Button>
                                                </div>
                                                <Badge className="absolute top-2 right-2 bg-pink-500">
                                                    {new Date(photo.timestamp).toLocaleTimeString('ja-JP', {
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    })}
                                                </Badge>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </Card>
                        </div>
                    </div>

                    <canvas ref={canvasRef} className="hidden" />
                </div>
            );
        };

        // PurikuraDecorator Component
        const PurikuraDecorator = ({ imageUrl, onSave }) => {
            const canvasRef = useRef(null);
            const [textElements, setTextElements] = useState([]);
            const [stickerElements, setStickerElements] = useState([]);
            const [newText, setNewText] = useState('');
            const [selectedColor, setSelectedColor] = useState('#FF69B4');
            const [textSize, setTextSize] = useState([24]);
            const [selectedElement, setSelectedElement] = useState(null);

            const stamps = [
                { id: '1', emoji: '💖', name: 'ハート' },
                { id: '2', emoji: '⭐', name: 'スター' },
                { id: '3', emoji: '🌸', name: 'サクラ' },
                { id: '4', emoji: '🦄', name: 'ユニコーン' },
                { id: '5', emoji: '🌈', name: 'にじ' },
                { id: '6', emoji: '✨', name: 'キラキラ' },
                { id: '7', emoji: '🎀', name: 'リボン' },
                { id: '8', emoji: '👑', name: 'クラウン' },
                { id: '9', emoji: '🍓', name: 'イチゴ' },
                { id: '10', emoji: '🧸', name: 'テディ' },
                { id: '11', emoji: '🌺', name: 'ハイビスカス' },
                { id: '12', emoji: '🎈', name: 'バルーン' }
            ];

            const colors = [
                '#FF69B4', '#FF1493', '#FFB6C1', '#FFC0CB',
                '#DDA0DD', '#9370DB', '#8A2BE2', '#4B0082',
                '#00CED1', '#40E0D0', '#48D1CC', '#AFEEEE',
                '#FFD700', '#FFA500', '#FF6347', '#FF4500'
            ];

            const addText = () => {
                if (!newText.trim()) return;
                
                const element = {
                    id: Date.now().toString(),
                    text: newText,
                    x: Math.random() * 200 + 50,
                    y: Math.random() * 200 + 50,
                    color: selectedColor,
                    size: textSize[0],
                    rotation: 0
                };
                
                setTextElements(prev => [...prev, element]);
                setNewText('');
            };

            const addSticker = (stamp) => {
                const element = {
                    id: Date.now().toString(),
                    emoji: stamp.emoji,
                    x: Math.random() * 200 + 50,
                    y: Math.random() * 200 + 50,
                    size: 40,
                    rotation: 0
                };
                
                setStickerElements(prev => [...prev, element]);
            };

            const deleteElement = (id) => {
                setTextElements(prev => prev.filter(el => el.id !== id));
                setStickerElements(prev => prev.filter(el => el.id !== id));
                setSelectedElement(null);
            };

            const rotateElement = (id) => {
                setTextElements(prev => prev.map(el => 
                    el.id === id ? { ...el, rotation: el.rotation + 15 } : el
                ));
                setStickerElements(prev => prev.map(el => 
                    el.id === id ? { ...el, rotation: el.rotation + 15 } : el
                ));
            };

            const saveDecoratedImage = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                if (!ctx) return;

                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    ctx.drawImage(img, 0, 0);
                    
                    stickerElements.forEach(sticker => {
                        ctx.save();
                        ctx.translate(sticker.x, sticker.y);
                        ctx.rotate(sticker.rotation * Math.PI / 180);
                        ctx.fillStyle = sticker.emoji;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = `${sticker.size}px serif`;
                        ctx.fillText(sticker.emoji, 0, 0);
                        ctx.restore();
                    });
                    
                    textElements.forEach(text => {
                        ctx.save();
                        ctx.translate(text.x, text.y);
                        ctx.rotate(text.rotation * Math.PI / 180);
                        ctx.fillStyle = text.color;
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 3;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = `bold ${text.size}px "Comic Sans MS", cursive`;
                        ctx.strokeText(text.text, 0, 0);
                        ctx.fillText(text.text, 0, 0);
                        ctx.restore();
                    });
                    
                    const decoratedUrl = canvas.toDataURL('image/png');
                    onSave(decoratedUrl);
                };
                img.src = imageUrl;
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2">
                        <Card className="p-4 bg-white/80 backdrop-blur-sm border-pink-200">
                            <div className="relative bg-gray-100 rounded-lg overflow-hidden">
                                <img 
                                    src={imageUrl} 
                                    alt="編集中の写真" 
                                    className="w-full h-auto max-h-96 object-contain"
                                />
                                
                                {textElements.map(text => (
                                    <div
                                        key={text.id}
                                        className={`absolute cursor-pointer select-none ${
                                            selectedElement === text.id ? 'ring-2 ring-pink-500' : ''
                                        }`}
                                        style={{
                                            left: text.x,
                                            top: text.y,
                                            color: text.color,
                                            fontSize: text.size,
                                            transform: `translate(-50%, -50%) rotate(${text.rotation}deg)`,
                                            fontFamily: '"Comic Sans MS", cursive',
                                            fontWeight: 'bold',
                                            textShadow: '2px 2px 0px white, -2px -2px 0px white, 2px -2px 0px white, -2px 2px 0px white'
                                        }}
                                        onClick={() => setSelectedElement(text.id)}
                                    >
                                        {text.text}
                                    </div>
                                ))}
                                
                                {stickerElements.map(sticker => (
                                    <div
                                        key={sticker.id}
                                        className={`absolute cursor-pointer select-none ${
                                            selectedElement === sticker.id ? 'ring-2 ring-pink-500' : ''
                                        }`}
                                        style={{
                                            left: sticker.x,
                                            top: sticker.y,
                                            fontSize: sticker.size,
                                            transform: `translate(-50%, -50%) rotate(${sticker.rotation}deg)`,
                                        }}
                                        onClick={() => setSelectedElement(sticker.id)}
                                    >
                                        {sticker.emoji}
                                    </div>
                                ))}
                            </div>
                            
                            {selectedElement && (
                                <div className="flex gap-2 mt-4 justify-center">
                                    <Button
                                        size="sm"
                                        variant="outline"
                                        onClick={() => rotateElement(selectedElement)}
                                    >
                                        <RotateCw className="h-4 w-4" />
                                    </Button>
                                    <Button
                                        size="sm"
                                        variant="destructive"
                                        onClick={() => deleteElement(selectedElement)}
                                    >
                                        <Trash2 className="h-4 w-4" />
                                    </Button>
                                </div>
                            )}
                            
                            <div className="flex justify-center mt-6">
                                <Button
                                    onClick={saveDecoratedImage}
                                    className="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white px-8"
                                >
                                    デコレーション完了
                                </Button>
                            </div>
                        </Card>
                    </div>

                    <div>
                        <Card className="p-4 bg-white/80 backdrop-blur-sm border-pink-200">
                            <Tabs defaultValue="text" className="w-full">
                                <TabsList className="grid w-full grid-cols-2 mb-4">
                                    <TabsTrigger value="text">
                                        <Type className="h-4 w-4 mr-1" />
                                        文字
                                    </TabsTrigger>
                                    <TabsTrigger value="stickers">
                                        <Sticker className="h-4 w-4 mr-1" />
                                        スタンプ
                                    </TabsTrigger>
                                </TabsList>

                                <TabsContent value="text" className="space-y-4">
                                    <div>
                                        <Label htmlFor="text-input">テキスト</Label>
                                        <Input
                                            id="text-input"
                                            value={newText}
                                            onChange={(e) => setNewText(e.target.value)}
                                            placeholder="テキストを入力"
                                            onKeyPress={(e) => e.key === 'Enter' && addText()}
                                        />
                                    </div>
                                    
                                    <div>
                                        <Label>文字サイズ: {textSize[0]}px</Label>
                                        <Slider
                                            value={textSize}
                                            onValueChange={setTextSize}
                                            max={48}
                                            min={12}
                                            step={2}
                                            className="mt-2"
                                        />
                                    </div>
                                    
                                    <div>
                                        <Label>文字色</Label>
                                        <div className="grid grid-cols-4 gap-2 mt-2">
                                            {colors.map((color) => (
                                                <button
                                                    key={color}
                                                    className={`w-8 h-8 rounded-full border-2 ${
                                                        selectedColor === color ? 'border-black' : 'border-gray-300'
                                                    }`}
                                                    style={{ backgroundColor: color }}
                                                    onClick={() => setSelectedColor(color)}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <Button onClick={addText} className="w-full">
                                        <Type className="h-4 w-4 mr-2" />
                                        テキスト追加
                                    </Button>
                                </TabsContent>

                                <TabsContent value="stickers">
                                    <div className="grid grid-cols-3 gap-2 max-h-80 overflow-y-auto">
                                        {stamps.map((stamp) => (
                                            <Button
                                                key={stamp.id}
                                                variant="outline"
                                                className="aspect-square flex flex-col items-center justify-center p-2 hover:bg-pink-50"
                                                onClick={() => addSticker(stamp)}
                                            >
                                                <span className="text-2xl mb-1">{stamp.emoji}</span>
                                                <span className="text-xs">{stamp.name}</span>
                                            </Button>
                                        ))}
                                    </div>
                                </TabsContent>
                            </Tabs>
                        </Card>
                    </div>
                    
                    <canvas ref={canvasRef} className="hidden" />
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [mode, setMode] = useState('camera');
            const [selectedPhoto, setSelectedPhoto] = useState(null);
            const [savedPhotos, setSavedPhotos] = useState([]);

            const handlePhotoCapture = (photoUrl) => {
                const newPhoto = {
                    id: Date.now().toString(),
                    originalUrl: photoUrl,
                    timestamp: Date.now()
                };
                setSavedPhotos(prev => [newPhoto, ...prev]);
                setSelectedPhoto(photoUrl);
                setMode('decorator');
            };

            const handleDecorationSave = (decoratedUrl) => {
                if (selectedPhoto) {
                    setSavedPhotos(prev => prev.map(photo => 
                        photo.originalUrl === selectedPhoto 
                            ? { ...photo, decoratedUrl }
                            : photo
                    ));
                }
                setMode('gallery');
            };

            const downloadPhoto = (photoUrl, filename) => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = photoUrl;
                link.click();
            };

            const sharePhoto = async (photoUrl) => {
                if (navigator.share) {
                    try {
                        const response = await fetch(photoUrl);
                        const blob = await response.blob();
                        const file = new File([blob], 'purikura.png', { type: 'image/png' });
                        
                        await navigator.share({
                            title: 'プリクラ写真',
                            text: '可愛い写真が撮れました！',
                            files: [file],
                        });
                    } catch (err) {
                        console.log('Share failed:', err);
                        try {
                            await navigator.clipboard.writeText('プリクラ写真をシェアしました！');
                        } catch (clipErr) {
                            console.log('Clipboard failed:', clipErr);
                        }
                    }
                } else {
                    try {
                        await navigator.clipboard.writeText(window.location.href);
                        alert('リンクがクリップボードにコピーされました！');
                    } catch (err) {
                        console.log('Fallback share failed:', err);
                    }
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-pink-100 via-purple-50 to-blue-100">
                    <div className="bg-white/80 backdrop-blur-sm border-b border-pink-200 sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto px-4 py-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    {mode !== 'camera' && (
                                        <Button
                                            variant="ghost"
                                            onClick={() => {
                                                if (mode === 'decorator') {
                                                    setMode('camera');
                                                    setSelectedPhoto(null);
                                                } else {
                                                    setMode('camera');
                                                }
                                            }}
                                        >
                                            <ArrowLeft className="h-4 w-4 mr-2" />
                                            戻る
                                        </Button>
                                    )}
                                    <h1 className="bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent font-bold text-2xl">
                                        ✨ プリクラ ✨
                                    </h1>
                                </div>
                                
                                <div className="flex gap-2">
                                    <Button
                                        variant={mode === 'camera' ? 'default' : 'ghost'}
                                        onClick={() => setMode('camera')}
                                        size="sm"
                                    >
                                        <Camera className="h-4 w-4 mr-1" />
                                        撮影
                                    </Button>
                                    <Button
                                        variant={mode === 'gallery' ? 'default' : 'ghost'}
                                        onClick={() => setMode('gallery')}
                                        size="sm"
                                    >
                                        <Palette className="h-4 w-4 mr-1" />
                                        ギャラリー ({savedPhotos.length})
                                    </Button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="p-4">
                        {mode === 'camera' && (
                            <PurikuraCamera onPhotoCapture={handlePhotoCapture} />
                        )}

                        {mode === 'decorator' && selectedPhoto && (
                            <div className="max-w-6xl mx-auto">
                                <div className="text-center mb-6">
                                    <h2 className="mb-2">デコレーション</h2>
                                    <p className="text-muted-foreground">可愛くデコレーションしよう！</p>
                                </div>
                                <PurikuraDecorator
                                    imageUrl={selectedPhoto}
                                    onSave={handleDecorationSave}
                                />
                            </div>
                        )}

                        {mode === 'gallery' && (
                            <div className="max-w-6xl mx-auto">
                                <div className="text-center mb-6">
                                    <h2 className="mb-2">ギャラリー</h2>
                                    <p className="text-muted-foreground">撮影した写真一覧 ({savedPhotos.length}枚)</p>
                                </div>

                                {savedPhotos.length === 0 ? (
                                    <Card className="p-12 text-center bg-white/80 backdrop-blur-sm border-pink-200">
                                        <Camera className="h-16 w-16 mx-auto mb-4 text-pink-300" />
                                        <h3 className="mb-2">まだ写真がありません</h3>
                                        <p className="text-muted-foreground mb-4">
                                            撮影ボタンから可愛い写真を撮ってみよう！
                                        </p>
                                        <Button 
                                            onClick={() => setMode('camera')}
                                            className="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700"
                                        >
                                            <Camera className="h-4 w-4 mr-2" />
                                            撮影を始める
                                        </Button>
                                    </Card>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {savedPhotos.map((photo) => (
                                            <Card key={photo.id} className="p-4 bg-white/80 backdrop-blur-sm border-pink-200 hover:shadow-lg transition-shadow">
                                                <div className="space-y-3">
                                                    <div className="relative group">
                                                        {photo.decoratedUrl ? (
                                                            <img
                                                                src={photo.decoratedUrl}
                                                                alt="デコレーション済み写真"
                                                                className="w-full h-48 object-cover rounded-lg"
                                                            />
                                                        ) : (
                                                            <img
                                                                src={photo.originalUrl}
                                                                alt="撮影した写真"
                                                                className="w-full h-48 object-cover rounded-lg"
                                                            />
                                                        )}
                                                        {photo.decoratedUrl && (
                                                            <div className="absolute top-2 left-2">
                                                                <span className="bg-pink-500 text-white px-2 py-1 rounded-full text-sm">
                                                                    ✨ デコ済み
                                                                </span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="text-sm text-muted-foreground text-center">
                                                        {new Date(photo.timestamp).toLocaleString('ja-JP')}
                                                    </div>
                                                    
                                                    <div className="flex gap-2">
                                                        {!photo.decoratedUrl && (
                                                            <Button
                                                                variant="outline"
                                                                size="sm"
                                                                onClick={() => {
                                                                    setSelectedPhoto(photo.originalUrl);
                                                                    setMode('decorator');
                                                                }}
                                                                className="flex-1 hover:bg-pink-50"
                                                            >
                                                                <Palette className="h-4 w-4 mr-1" />
                                                                デコる
                                                            </Button>
                                                        )}
                                                        
                                                        <Button
                                                            variant="outline"
                                                            size="sm"
                                                            onClick={() => downloadPhoto(
                                                                photo.decoratedUrl || photo.originalUrl,
                                                                `purikura-${photo.timestamp}.png`
                                                            )}
                                                            className="flex-1 hover:bg-blue-50"
                                                        >
                                                            <Download className="h-4 w-4 mr-1" />
                                                            保存
                                                        </Button>
                                                        
                                                        <Button
                                                            variant="outline"
                                                            size="sm"
                                                            onClick={() => sharePhoto(photo.decoratedUrl || photo.originalUrl)}
                                                            className="flex-1 hover:bg-green-50"
                                                        >
                                                            <Share2 className="h-4 w-4 mr-1" />
                                                            共有
                                                        </Button>
                                                    </div>
                                                </div>
                                            </Card>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>