<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>u2net-tfjs カメラテスト</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    video, canvas { border: 1px solid #ccc; width: 480px; height: 360px; margin: 10px; }
    button { padding: 10px 20px; margin: 10px; }
  </style>
</head>
<body>
  <h2>u2net-tfjs カメラ背景除去デモ</h2>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas" width="480" height="360"></canvas>
  <button id="startBtn">カメラ開始</button>
  <button id="stopBtn" disabled>カメラ停止</button>

  <!-- u2net-tfjs index.js（GitHubから直接読み込み） -->
  <script src="https://raw.githubusercontent.com/pw56/u2net-tfjs/refs/heads/master/index.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');

    let stream = null;
    let model = null;
    let running = false;

    async function loadModel() {
      model = await u2net.loadModel(); // index.js に定義された関数
    }

    async function startCamera() {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      running = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      loop();
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      running = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    async function loop() {
      if (!model || !running) return;

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

      const result = await u2net.removeBackground(model, imageData); // index.js の removeBackground 関数
      ctx.putImageData(result, 0, 0);

      requestAnimationFrame(loop);
    }

    startBtn.addEventListener('click', async () => {
      if (!model) await loadModel();
      await startCamera();
    });

    stopBtn.addEventListener('click', stopCamera);
  </script>
</body>
</html>